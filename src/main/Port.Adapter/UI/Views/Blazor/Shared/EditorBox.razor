@using ei8.Cortex.Diary.Port.Adapter.UI.Views.Blazor.Data;
@using ei8.Cortex.Diary.Application.Neurons;
@using ei8.Cortex.Library.Client;   
@using ei8.Cortex.Library.Common;
@using ei8.Cortex.Diary.Port.Adapter.UI.Common;
@using ei8.Cortex.Diary.Port.Adapter.UI.ViewModels;
@using neurUL.Cortex.Common;
@inject INeuronApplicationService NeuronApplicationService;

<div class="container-fluid">
    <EditForm Model="@editorNeuronViewModel">
        <div class="row">
            <div class="col p-0">
                <div class="container-fluid">
                    @if (this.SelectedOption == ContextMenuOption.AddRelative)
                    {
                        <div class="row">
                            <div class="col p-0">
                                <p class="p-0 m-0 font-weight-bold">
                                    @("Adding New Relative to '" + this.CentralNeuron.Tag + "'")
                                </p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col p-0 pr-1 col-auto">
                                <NullableInputSelect class="btn btn-secondary btn-sm dropdown-toggle" T="RelativeType" @bind-Value="this.editorNeuronViewModel.RelativeType">
                                    <option value="">--Select Type--</option>
                                    <option value="@RelativeType.Postsynaptic">Postsynaptic</option>
                                    <option value="@RelativeType.Presynaptic">Presynaptic</option>
                                </NullableInputSelect>
                            </div>
                            <div class="col p-0 pr-1 col-auto">
                                <NullableInputSelect class="btn btn-secondary btn-sm dropdown-toggle" T="NeurotransmitterEffect" @bind-Value="this.editorNeuronViewModel.Effect">
                                    <option value="">--Select Effect--</option>
                                    <option value="@NeurotransmitterEffect.Excite">Excite</option>
                                    <option value="@NeurotransmitterEffect.Inhibit">Inhibit</option>
                                </NullableInputSelect>
                            </div>
                            <div class="col pr-1 p-0">
                                <InputNumber class="form-control-xs" placeholder="Strength" @bind-Value="this.editorNeuronViewModel.Strength" />
                            </div>
                        </div>
                    }
                    <div class="row">
                        <div class="col pt-1 pb-1 p-0">
                            <InputTextArea class="form-control w-100" placeholder="Tag" @bind-Value="@this.editorNeuronViewModel.Tag" rows="4" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-1 flex-fixed-width-item">
                <div class="container h-100">
                    <div class="row h-50 justify-content-end">
                        <div class="col p-0">
                            <button class="btn btn-secondary btn-sm" style="width:80px" @onclick="OnCancel">Cancel</button>
                        </div>
                    </div>
                    <div class="row h-50 align-items-end justify-content-end">
                        <div class="col p-0">
                            <button class="btn btn-primary btn-sm" style="width:80px" @onclick="OnSend">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </EditForm>
</div>

@code {
    private EditorNeuronViewModel editorNeuronViewModel = new EditorNeuronViewModel();

    [Parameter]
    public string AvatarUrl { get; set; }

    private ContextMenuOption selectedOption { get; set; }
    [Parameter]
    public ContextMenuOption SelectedOption
    {
        get => this.selectedOption;
        set
        {
            if (this.selectedOption != value)
            {
                this.selectedOption = value;
                this.SelectedOptionChanged.InvokeAsync(this.selectedOption);
            }
        }
    }

    [Parameter]
    public EventCallback<ContextMenuOption> SelectedOptionChanged { get; set; }

    private NeuronViewModel selectedNeuron;
    [Parameter]
    public NeuronViewModel SelectedNeuron
    {
        get => this.selectedNeuron;
        set
        {
            if (this.selectedNeuron != value)
            {
                this.selectedNeuron = value;
                if (this.selectedNeuron != null)
                {
                    this.editorNeuronViewModel.Id = this.selectedNeuron.Neuron.Id;
                    this.editorNeuronViewModel.Tag = this.selectedNeuron.Tag;
                    // TODO: this.editorNeuronViewModel.Effect = targetNeuron.Effect;
                    //this.editorNeuronViewModel.Strength = targetNeuron.Strength;
                    //this.editorNeuronViewModel.RelativeType = targetNeuron.RelativeType;
                    //this.editorNeuronViewModel.RegionId = targetNeuron.RegionId;
                    //this.editorNeuronViewModel.RegionName = targetNeuron.RegionName;
                    this.editorNeuronViewModel.Version = this.selectedNeuron.Neuron.Version;
                }
            }

            if (this.selectedNeuron == null)
                this.editorNeuronViewModel.Initialize();
        }
    }

    [Parameter]
    public NeuronViewModel CentralNeuron { get; set; }

    private async Task OnSend()
    {
        if (
            !string.IsNullOrEmpty(this.editorNeuronViewModel.Tag) &&
            QueryUrl.TryParse(this.AvatarUrl, out QueryUrl result)
            )
        {
            switch (this.SelectedOption)
            {
                case ContextMenuOption.New:
                    await this.NeuronApplicationService.CreateNeuron(result.AvatarUrl, Guid.NewGuid().ToString(), this.editorNeuronViewModel.Tag, string.Empty);
                    break;
                case ContextMenuOption.Edit:
                    await this.NeuronApplicationService.ChangeNeuronTag(result.AvatarUrl, this.editorNeuronViewModel.Id, this.editorNeuronViewModel.Tag, this.editorNeuronViewModel.Version);
                    break;
            }

            Blazor.Helper.ReinitializeOption(o => this.SelectedOption = o);
        }
    }

    private async Task OnCancel()
    {
        // TODO: ask user if sure to proceed, all unsaved changes (if any) will be lost        
        Blazor.Helper.ReinitializeOption(o => this.SelectedOption = o);
    }
}
